---
title: Analysis of "Islamophobia and Media Portrayals of Muslim Women"
author: "Sean Hughes"
date: "April 13, 2019"
output:
 pdf_document:
  md_extension: +raw_tex
header-includes:
    - \usepackage{caption}
    - \usepackage{float}
    - \usepackage{lipsum}
---

\captionsetup[table]{labelformat=empty}

```{r libraries, include=FALSE}
rm(list=ls())


## This file contains all figures and charts used in the final writeup
## All figures and charts are saved as RDS files, and accessed via readRDS
##    in the final writeup

# Load required libraries

library(tidyverse)
library(dplyr)
require(plyr)
require("MASS")
require("xtable")
require(plm) # panel data operations
require(ggplot2) # visualizations
require(stargazer) # pretty tables
require(sandwich) # for robust standard errors
require(lmtest) # for robust standard errors
require(sampleSelection) # for heckman correction
require(mfx) # for marginal effects
require(Matching) # required by the interaction_plots.R script below
require(stm)
library(scales)
library(countrycode)
library(gt)
library(xaringan)
require(gridExtra)
source("dataverse_files/interaction_plots.R") # for interaction plots; see paper for attribution

```

```{r dataPrep, include=FALSE}

##############
# Prepare Data
##############

# load STM data

load("dataverse_files/stm.RData")

# load country-year data

rt <- read.csv("./dataverse_files/country-year.csv")

# Create a seperate copy of the data before making alterations

rt_original <- rt

############################################################
# The following data prep is drawn directly from Terman code
############################################################

# Alter names of the columns

rt <- rt[,c("ccode", "year", "n.docs", "n.words", "n.binary", "rights", "alt.dv.perc", "muslim", "muslim.maj", "mena", "polity2", "physint", "amnesty", "statedept", "gdp.pc.un", "pop.wdi", "wopol", "wosoc", "wecon", "domestic9", "count", "region")]

# Deal with Palestine (without ccode)

rt$ccode[is.na(rt$ccode)] <- 999

# composite women's rights

rt$women_composite <- rowMeans(cbind(rt$wopol,rt$wosoc,rt$wecon), na.rm = T)

# assign israel *outside* MENA (see robustness tests, below)

rt$mena[rt$ccode == 666] <- 0

# n.obs

nrow(rt[rt$year>1979,]) # 6292

# make panel data

names(rt)
rt <- pdata.frame(rt, c("ccode","year"))

# set lagged variables

rt$n.docs.lag <- lag(rt$n.docs, 1)
rt$n.binary.lag <- lag(rt$n.binary, 1)
rt$rights.lag <- lag(rt$rights, 1)
rt$alt.dv.perc.lag <- lag(rt$alt.dv.perc, 1)
rt$muslim.maj <- lag(rt$muslim.maj, 1)
rt$muslim_no_lag <- rt$muslim
rt$muslim <- lag(rt$muslim, 1)
rt$women_composite <- lag(rt$women_composite, 1)
rt$wopol <- lag(rt$wopol, 1)
rt$wosoc <- lag(rt$wosoc, 1)
rt$wecon <- lag(rt$wecon, 1)
rt$count <- lag(rt$count, 1)
rt$polity2 <- lag(rt$polity2, 1)
rt$domestic9 <- lag(rt$domestic9, 1)
rt$pop.wdi <- lag(rt$pop.wdi, 1)
rt$gdp.pc.un <- lag(rt$gdp.pc.un, 1)

# before, after 9/11

rt.before <- rt[as.numeric(levels(rt$year))<2002,]
rt.after <- rt[as.numeric(levels(rt$year))>=2002,]

# muslim maj and non-Muslim maj

muslim.maj <- rt[rt$muslim.maj == 1,]
muslim.maj <- muslim.maj[!is.na(muslim.maj$region),]
non.muslim.maj <- rt[rt$muslim.maj == 0,]
non.muslim.maj <- non.muslim.maj[!is.na(non.muslim.maj$region),]

rt %>% arrange(desc(gdp.pc.un))

```

```{r cleanData, echo=FALSE, include=FALSE}

# The data colums are the following:

# ccode: COW Numeric Country Code (countrycode package)      
# year:       

# n.docs: number of articles for a given country year in sample    

# n.words: number of total words in all articles for a given country year 

# n.binary: a binary (0/1) indicator for whether a given country year had at least 1 article in sample.   

# rights: average weight on the topic of women's rights for articles about a given country year. See paper for more explanation -- this is the main DV.  

# alt.dv.perc: The proportion of articles that mentioned words right, equal, discriminat. An alternative measure of the DV (see paper).

# muslim: Percentage of population that is Muslim.      

# muslim.maj: 0/1 indicator for whether population is majority Muslim.  

# mena: 0/1 indicator for whether country is in MENA region.        

# polity2: combined polity score 2 (see polity IV project)     

# physint CIRI physical integrity score (see CIRI data)    

# amnesty: PTS Amnesty (see Political Terror Score data)     

# statedept  PTS State Department (see Political Terror Score data) 

# gdp.pc.un: GDP per capita, current US$ (UN data)  

# pop.wdi: WDI population mid-year estimates (World Bank Development Indicators)     

# wopol: CIRI Women’s Political Rights (see CIRI data)         

# wosoc: CIRI Women’s Social Rights (see CIRI data)         

# wecon: CIRI Women’s Economic Rights (see CIRI data)   

# women_composite: Average of the three CIRI scores

# domestic9: Domestic Conflict / Stability Index (Cross National Time Series Data, Banks (2012))   

# count: Number of articles mentioning country-year in the NYT (see paper)      

# region: Region classification

#############################

# Add in country names to the dataset
# Manually add in Palestine as it is not contained in the ccode dataset

rt_altered <- rt %>% 
  mutate(country_name = case_when(
    ccode == 999 ~ "Palestine",
    TRUE ~ countrycode((ccode), "cown", "country.name")
  ))  %>% 
  
  # Set the year to be a number
  
  mutate(year = as.numeric(as.character(year))) %>% 
  
  # Create a unique key for each row
  
  mutate(ccodeyear = paste0(ccode, year)) %>% 
  
  # For count data, set all NA values to 0 for consistency
  
  mutate(count=case_when(
    is.na(count) ~ as.integer(0),
    TRUE ~ as.integer(count)
  )) %>% 
  
  mutate(n.docs=case_when(
    is.na(n.docs) ~ as.integer(0),
    TRUE ~ as.integer(n.docs)
  ))
              
```

# Table 1 & 2 Charts


# Data Analysis Charts


```{r analyzeData1, echo=FALSE}

####################
# Data visualization
####################

# The datapoints we will look at
# --- Qualifying Points ---
#    1. Muslim Percentage
#    2. Women's rights Index
#    3. Democracy
#    4. Instability
#    5. Population
#    6. GDP per Capita
#
# --- Left side Variable ---
#    1. Number of articles
#    2. Analysis of text

######################
# 1. Muslim Percentage
######################

# Plot 1: Create a plot of the muslim percentage

p1 <- ggplot(rt_altered, aes(x = year, y = muslim, color = ccode)) + 
  geom_line(show.legend = FALSE) +
  labs(x = "Year", y = "Perentage Muslim (%)", title = "Percentage Muslim over Time by Country") +
  scale_y_continuous(labels=percent)

# Plot 2: Size of change of data over the whole period

rt_altered2 <- rt_altered %>% filter(year != 1979) %>% 
  mutate(change_muslim = muslim_no_lag - muslim)

p2 <- ggplot(rt_altered2) + geom_histogram(aes(change_muslim), bins = 200)

# look at outliers where the percentage muslim is greater than 90%

# We see Montenegro, Azerbaijan, Brunei, and Timor-Leste
  # Montenegro 2006 - independance declared
  # Azerbaijan 1991 - Independance declared
  # Brunei 1984 - Independance declared
  # Timor Leste - Independence, Population from Indonesian

# FINDINGS:
# Palestine goes from .04 to .98 to .04.... how does this affect the data?
  # How many news articles are written about palestine?
  # It appears that when she intended to fix the data by correcting for numbers 999
  # I also question the percentage used for palestine
# Some countries have huge swings that seem impossible, but soon can be seen as a product
  # of political circumstances such as independence etc
# Verified other data points randomly with other sources and appear accurate
# Timor Leste has a population of 254,000,000??

# A look at potential impact of palestinian article. There are articles written in both the categories! But it appears that this has been accounted for.

# Save RDS files for access in presentation
saveRDS(p1, "./pres_resources/muslim1.RDS")
saveRDS(p2, "./pres_resources/muslim2.RDS")

```

```{r analyzedata2, echo=FALSE}

####################
# Data visualization
####################

#########################
# 2. Women's Rights Index
#########################

# has values between 0 and 3
# - Uses CingranelliRichards Rights Index (CIRI) as measure of women's rights status
#	  - has 3 measures: Women’s Economic Rights, Women’s Political Rights, and Women’s Social Rights
#		- 0 means that women rights were not respected in law or practice
#		- 3 means that women rights were respected in law and practice

# Plot 1: Create a plot of the muslim percentage

w1 <- ggplot(rt_altered, aes(x = year, y = women_composite, color = ccode)) + 
  geom_line(show.legend = FALSE) +
  labs(x = "Year", y = "Women's Rights Index", title="Composite Women's Rights Index over Time")

# Save the RDS for the prez

saveRDS(w1, "./pres_resources/women1.RDS")

# Interesting to look at this just by women's rights, without the added women component

plot_data <- rt_altered %>% 
  filter(!is.na(n.docs)) %>% 
  filter(!is.na(muslim)) %>% 
  filter(!is.na(pop.wdi)) %>% 
  filter(!is.na(women_composite)) %>% 
  mutate(num_muslims = muslim*pop.wdi,
         women_treat_tot = women_composite*pop.wdi) %>% 
  group_by(region, year) %>% 
  dplyr::summarize(num_docs = sum(n.docs),
            tot_muslims = sum(num_muslims),
            tot_population = sum(pop.wdi),
            tot_women_treat = sum(women_treat_tot)) %>% 
  mutate(muslim_perc = tot_muslims / tot_population,
         women_perc = tot_women_treat / tot_population) %>% 
  mutate(doc.p.person = num_docs/tot_population)

# Make a plot with all 3 of these things: women rights, muslim percentage


# Conclusion is just the linear model without muslim pct, just treatment of women

totplot1 <- plot_data %>% filter(year == 1985) %>% 
  ggplot(aes(x = muslim_perc, y = women_perc, color = region, label=region)) + 
  geom_point(aes(size = doc.p.person), alpha = .7) +
  geom_point(alpha = .8, color = "black") +
  scale_size_continuous(range = c(6, 25)) +
  geom_text(aes(label=region),hjust=-.5, vjust=0, colour = 'black') +
  xlim(0, 1.2) +
  ylim(0, 3) +
  labs(x = 'Percentage Muslim', y='Womens Rights Composite Score (1-3 scale)',
       title = 'Docs per Person (1985) by Womens Rights and Muslim Percentage in a Given Region')

saveRDS(totplot1, "./pres_resources/totplot1.RDS")

```

```{r plotData, echo=FALSE}

####################
# Data visualization
####################

# Create a graph with only muslim countries, showing average
#  women's composite right score per year

mus_only <- plot_data %>% filter(region == "MENA") %>% 
  
  mutate(post911 = case_when(
   year > 2001 ~ "Post 9/11",
   TRUE ~ "Pre 9/11"
  )) %>% 
  
  ggplot(aes(x = num_docs, y = women_perc, color = post911, label=year)) + 
  
  geom_point(alpha = .7, size = 5) +
  
  geom_point(alpha = .8, color = "black", size = 1) +
  
  geom_text(aes(label=year),hjust=-.5, vjust=0, colour = 'black', size=2) +
  
  ylim(.6, 1.25) +
  
  labs(x = 'Number of Docs / Person', y='Womens Rights Composite Score (1-3 scale)',
       title = 'Docs per Person (1985) by Womens Rights and Muslim Percentage in a Given Region')
  
# Save data for presentation
  
saveRDS(mus_only, "./pres_resources/mus_only.RDS")

# Create a graph with only western countries, showing average
#  women's composite right score per year

west_only <- plot_data %>% filter(region == "West") %>%
  
    mutate(post911 = case_when(
   year > 2001 ~ "Post 9/11",
   TRUE ~ "Pre 9/11"
  )) %>% 
  
  ggplot(aes(x = num_docs, y = women_perc, color = post911, label=year)) + 
  
  geom_point(alpha = .7, size = 5) +
  
  geom_point(alpha = .8, color = "black", size = 1) +
  
  geom_text(aes(label=year),hjust=-.5, vjust=0, colour = 'black', size=2) +
  
  ylim(1.75, 3) +
  
  labs(x = 'Number of Docs / Person', y='Womens Rights Composite Score (1-3 scale)',
       title = 'Docs per Person (1985) by Womens Rights and Muslim Percentage in a Given Region')
  
# Save data for presentation
  
saveRDS(west_only, "./pres_resources/wes_only.RDS")

```

```{r thequantitylook2, echo=FALSE, warnings=FALSE}

####################
# Data visualization
####################

# Create a plot showing treatment of women over time in MENA

trend_plot <- rt_altered %>% 
  
  filter(year > 2001) %>% 
  
  filter(region == "MENA") %>% 
  
  ggplot(aes(x = women_composite, y = n.binary)) +
  
  geom_jitter(alpha = .3) +
  
  geom_smooth(method = "lm") +
  
  labs(x = "Treatment of Women Composite Score",
       y = "Number of Articles Written (Binary 0 or 1)",
       title = "Women Index vs. # Articles in MENA post 9/11")

saveRDS(trend_plot, "./pres_resources/trend_plot.RDS")
saveRDS(trend_plot, "./writeup_files/trend_plot.RDS")

# Create a plot showing treatment of women over time in West

trend_plot2 <- rt_altered %>% 
  filter(year > 2001) %>% 
  filter(region == "West") %>% 
  ggplot(aes(x = women_composite, y = n.binary)) +
  geom_jitter(alpha = .3) +
  geom_smooth(method = "lm") +
  labs(x = "Treatment of Women Composite Score",
       y = "Number of Articles Written (Binary 0 or 1)",
       title = "Women Index vs. # Articles in West post 9/11")

saveRDS(trend_plot2, "./pres_resources/trend_plot2.RDS")
saveRDS(trend_plot2, "./writeup_files/trend_plot2.RDS")

# Use grid arrange to put West and Mena plots next to eachother

grid.arrange(trend_plot, trend_plot2, ncol=2)

```

```{r printToPDF, include=FALSE}

# Use this function to print the presentation to PDF

# or just pass the HTML output file path to chrome_print()
#pagedown::chrome_print("presentation.html")

```

```{r tab1111, echo=FALSE, include=FALSE}

# Create a linear model for women's composite score based on several factors

logit5 <- lm(women_composite ~ muslim + polity2 + domestic9 + log(pop.wdi) + log(gdp.pc.un), data = rt )

```


```{r tab111ut1, echo=FALSE, results='asis', include=FALSE}

# print out model using stargazer

stargazer(logit5, 
          header=FALSE, 
          label = "table:probit", 
          style = "ajps", 
          title = "Probit Analysis of U.S. News Coverage about Women Abroad", 
          notes="Robust standard errors clustered on country appear in parentheses.", 
          star.cutoffs = c(0.05, 0.01, .001))

```

## Article Quantities

```{r part31, include=FALSE}

# Create histogram of document data for presentation

d1 <- rt_altered %>% 
  ggplot() +
  geom_histogram(aes(x = n.docs), bins = 30) +
  labs(x = "Number of Documents",
       y = "Number of Articles",
       title = "Distribution of Article Quantities")

saveRDS(d1, "./pres_resources/histogram1.RDS")

```

```{r part3, include=FALSE}

# Create histogram of binary article count data for presentation

d2 <- rt_altered %>% 
  ggplot() +
  geom_histogram(aes(x = n.binary), bins = 3) +
  labs(x = "Number of Documents",
       y = "Number of Articles",
       title = "Distribution of Article Quantities")

saveRDS(d2, "./pres_resources/histogram2.RDS")

```



###########
# Appendix
###########

## Table 1: Probit Analysis of U.S. News Coverage of Women Abroad

```{r tab1, echo=FALSE, include=FALSE}

# Run probit models on binary article count (n.binary)
# The comment above each model indicates the indicator of muslim country
#   that will be used

# MUSLIM MAJORITY

logit1 <- glm(n.binary ~ count + women_composite*muslim.maj + polity2 + domestic9 + log(pop.wdi) + log(gdp.pc.un), data = rt, family = binomial(link="probit"), control = list(maxit = 50))

logit1.se <- coeftest(logit1, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# MENA

logit2 <- glm(n.binary ~ count + women_composite*mena + polity2 + domestic9 + log(pop.wdi) + log(gdp.pc.un), data = rt, family = binomial(link="probit"), control = list(maxit = 50))

logit2.se <- coeftest(logit2, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# PERCENT MUSLIM

logit3 <- glm(n.binary ~ count + women_composite*muslim + polity2 + domestic9 + log(pop.wdi) + log(gdp.pc.un), data = rt, family = binomial(link="probit"), control = list(maxit = 50))

logit3.se <- coeftest(logit3, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

```

```{r tab1Out, echo=FALSE, results='asis'}

# Print out all 3 models using stargazer

stargazer(logit1, logit2, logit3, header=FALSE, label = "table:probit", style = "ajps", title = "Probit Analysis of U.S. News Coverage about Women Abroad", se = list(logit1.se, logit2.se, logit3.se), notes="Robust standard errors clustered on country appear in parentheses.",  dep.var.labels = "Repocountry.yeared (Binary)", covariate.labels=c("Country Repocountry.years", "Women's Rights Index","Muslim Majority","MENA", "Muslim Percentage", "Democracy", "Instability", "Population", "GDP per capita", "Women's Rights x Muslim Majority", "Women's Rights x MENA","Women's Rights x Muslim Percentage"), star.cutoffs = c(0.05, 0.01, .001))

# Put variables from stargazer table into easier names to be stored
# This is objectively a somewhat odd way of storing the data, however it is difficult
#   to save a stargazer table without saving all of its inputs and simply recreating the
#   table in the other file, so this was the best method I found

apent11 <- logit1
apent14 <- logit1.se
apent12 <- logit2
apent15 <- logit2.se
apent13 <- logit3
apent16 <- logit3.se

```

\pagebreak

## Table 2: Negative Binomial Analysis of U.S. News Coverage of Women Abroad

```{r tab2, results = 'asis', echo=FALSE}

# Run negative binomial models on article count (n.docs)
# The comment above each model indicates the indicator of muslim country
#   that will be used

# MUSLIM MAJORITY

nb1 <- glm.nb(n.docs ~ count + women_composite*muslim.maj + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),data = rt)
nb1.se <- coeftest(nb1, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# MENA

nb2 <- glm.nb(n.docs ~ count + women_composite*mena + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),data = rt)
nb2.se <- coeftest(nb2, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# MUSLIM PERCENTAGE

nb3 <- glm.nb(n.docs ~ count + women_composite*muslim + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),data = rt)
nb3.se <- coeftest(nb3, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# print out the table using stargazer

apent2 <- stargazer(nb1, nb2, nb3, label = "table:negbin", header=FALSE, title = "Negative Binomial Analysis of U.S. News Coverage about Women Abroad", style = "ajps", se = list(nb1.se, nb2.se, nb3.se), notes="Robust standard errors clustered on country appear in parentheses.",  dep.var.labels = "Reported (Count)", covariate.labels=c("Country Reports", "Women's Rights Index","Muslim Majority","MENA", "Muslim Percentage", "Democracy", "Instability", "Population", "GDP per capita", "Women's Rights x Muslim Majority", "Women's Rights x MENA","Women's Rights x Muslim Percentage"), star.cutoffs = c(0.05, 0.01, 0.001))

apent21 <- nb1
apent22 <- nb2
apent23 <- nb3
apent24 <- nb1.se
apent25 <- nb2.se
apent26 <- nb3.se

```

\pagebreak

## Table 3: Summary of Topic Labels

```{r tab3, results = 'asis', echo=FALSE}

# make a table with top words

prob <- labelTopics(model, n= 10)$prob
frex <- labelTopics(model, n=10)$frex
dat <- data.frame(labels)
names(dat) <- "Labels"
dat$Probability <- apply( prob, 1 , paste , collapse = ", " )
dat$FREX <- apply( frex, 1 , paste , collapse = ", " )

# export to html

print(xtable(dat))

apent3 <- dat

```



\pagebreak

## Table 4: Two-Step Analysis of Rights Focus in U.S. News Coverage of Women Abroad

```{r tab4, results = 'asis', echo=FALSE}

# The heckit model is only used in the quality hypothesis, so did not analyze

## Muslim Majority
heckit1 <- heckit(n.binary ~ count + women_composite*muslim.maj + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),
                 rights ~  women_composite + muslim.maj + polity2 + physint,
                 rt )
heckit1.se = coeftest(heckit1$lm, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# MENA
heckit2 <- heckit(n.binary ~ count + women_composite*mena + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),
                  rights ~ women_composite + mena + polity2 + physint,
                  rt )
heckit2.se = coeftest(heckit2$lm, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# Muslim percentage
heckit3 <- heckit(n.binary ~ count + women_composite*muslim + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),
                  rights ~ women_composite + muslim + polity2 + physint,
                  rt )
heckit3.se = coeftest(heckit3$lm, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]


# print - HTML
stargazer(heckit1$lm, heckit2$lm, heckit3$lm, header=FALSE,label = "table:heckit", style = "ajps", title = "Two-Step Analysis of Rights Focus in U.S. News Coverage about Women Abroad", se = list(heckit1.se, heckit2.se, heckit3.se), notes="Robust standard errors clustered on country appear in parentheses.",  dep.var.labels = "Rights Focus", covariate.labels=c("Intercept", "Women's Rights Index","Muslim Majority","MENA", "Muslim Percentage", "Democracy", "Physical Integrity Rights"), star.cutoffs = c(0.05, 0.01, 0.001))

apent41 <- heckit1$lm
apent42 <- heckit2$lm
apent43 <- heckit3$lm
apent44 <- heckit1.se
apent45 <- heckit2.se
apent46 <- heckit3.se

```

\pagebreak

## Figure 2: Marginal Effects of Women's Rights Index on Reported (Count)

```{r fig2, echo=FALSE}

# Use the interaction plot binary function to create an interaction plot of results
#  from model nb1

apen2 <- nb1

interaction_plot_binary(nb1, effect="women_composite", moderator="muslim.maj", interaction="women_composite:muslim.maj", factor_labels=c("Not Muslim Majority","Muslim Majority"), xlabel="", ylabel="Marginal Effect of Women's Rights on Coverage", title="")

saveRDS(apen2, './writeup_files/apen2.RDS')
```

\pagebreak

## Figure 3: Summary of Topic Prevalence

```{r fig3, echo=FALSE}

# This section is used in the quality hypothesis, so did not analyze
# Corpus Summary of Topic Proportions

apen3 <- model

plot.STM(model,type="summary",custom.labels=labels,main="")
```

\pagebreak

## Figure 4: Expected Document Proportions for Four Topics

```{r fig4, echo=FALSE}

# This section is used in the quality hypothesis, so did not analyze

#prep
prep <- estimateEffect(1:15 ~ REGION+s(YEAR),model,meta=meta,uncertainty="Global",documents=docs)
regions = c("Asia","EECA","MENA","Africa","West","LA")

apen41 <- prep
apen42 <- regions

par(mfrow=c(2,2))
# print prevalence graphs for 4 topics
for (i in c(3,7,9,14)){
  plot.estimateEffect(prep,"REGION",method="pointestimate",topics=i,printlegend=TRUE,labeltype="custom",custom.labels=regions,main=labels[i],ci.level=.95,nsims=100)
}

```




############
# War Stuff
############


```{r edit_data, echo=FALSE, include=FALSE}

########################################
# Goal is to filter out countries at war
########################################

# Countries at ware are: Afghanistan, Iraq, Syria, Yemen, Somalia, Libya, and Niger

# Create a list with all country names to remove

country_list <- c("Afghanistan", "Iraq", "Syria", "Yemen", "Somalia", "Libya", "Niger")

# Change country names into codes

country_codes <- countrycode((country_list), "country.name", "cown")
  
# Create a new rt dataset with these countries removed

rt_altered_war <- rt_altered %>% 
  
  filter(!(ccode %in% country_codes))

```

## Table 1: Probit Analysis of U.S. News Coverage about Women Abroad

```{r tab1m, echo=FALSE}

# Create probit models for the table using muslim data that has removed AW countries
# The comment above each model indicates the indicator of muslim country
#   that will be used

# MUSLIM MAJORITY

wlogit1 <- glm(n.binary ~ count + women_composite*muslim.maj + polity2 + domestic9 + log(pop.wdi) + log(gdp.pc.un), data = rt_altered_war, family = binomial(link="probit"), control = list(maxit = 50))
wlogit1.se <- coeftest(wlogit1, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# MENA

wlogit2 <- glm(n.binary ~ count + women_composite*mena + polity2 + domestic9 + log(pop.wdi) + log(gdp.pc.un), data = rt_altered_war, family = binomial(link="probit"), control = list(maxit = 50))
wlogit2.se <- coeftest(wlogit2, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# PERCENT MUSLIM

wlogit3 <- glm(n.binary ~ count + women_composite*muslim + polity2 + domestic9 + log(pop.wdi) + log(gdp.pc.un), data = rt_altered_war, family = binomial(link="probit"), control = list(maxit = 50))
wlogit3.se <- coeftest(wlogit3, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

```

```{r tab1mOut, echo=FALSE, results='asis'}

# PRINT out table using stargazer

stargazer(wlogit1, wlogit2, wlogit3, header=FALSE, label = "table:probit", style = "ajps", title = "Probit Analysis of U.S. News Coverage about Women Abroad", se = list(wlogit1.se, wlogit2.se, wlogit3.se), notes="Robust standard errors clustered on country appear in parentheses.",  dep.var.labels = "Repocountry.yeared (Binary)", covariate.labels=c("Country Repocountry.years", "Women's Rights Index","Muslim Majority","MENA", "Muslim Percentage", "Democracy", "Instability", "Population", "GDP per capita", "Women's Rights x Muslim Majority", "Women's Rights x MENA","Women's Rights x Muslim Percentage"), star.cutoffs = c(0.05, 0.01, .001))
```

\pagebreak

## Table 2: Negative Binomial Analysis of U.S. News Coverage of Women Abroad

```{r tab2m, results = 'asis', echo=FALSE}

# Use a negative binomial analysis to analyze count data
# The comment above each model indicates the indicator of muslim country
#   that will be used

# MUSLIM MAJORITY

wnb1 <- glm.nb(n.docs ~ count + women_composite*muslim.maj + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),data = rt_altered_war)
wnb1.se <- coeftest(wnb1, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# MENA

wnb2 <- glm.nb(n.docs ~ count + women_composite*mena + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),data = rt_altered_war)
wnb2.se <- coeftest(wnb2, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# MUSLIM PERCENTAGE

wnb3 <- glm.nb(n.docs ~ count + women_composite*muslim + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),data = rt_altered_war)
wnb3.se <- coeftest(wnb3, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# PRINT out model data using stargazer

stargazer(wnb1, wnb2, wnb3, label = "table:negbin", header=FALSE, title = "Negative Binomial Analysis of U.S. News Coverage about Women Abroad", style = "ajps", se = list(wnb1.se, wnb2.se, wnb3.se), notes="Robust standard errors clustered on country appear in parentheses.",  dep.var.labels = "Reported (Count)", covariate.labels=c("Country Reports", "Women's Rights Index","Muslim Majority","MENA", "Muslim Percentage", "Democracy", "Instability", "Population", "GDP per capita", "Women's Rights x Muslim Majority", "Women's Rights x MENA","Women's Rights x Muslim Percentage"), star.cutoffs = c(0.05, 0.01, 0.001))

```

\pagebreak

## Figure 2: Marginal Effects of Women's Rights Index on Reported (Count)

```{r interactionPlot, include=FALSE}

# Create an altered version of the interaction_plot_binary function 
#   This function returns results as a dataframe rather than a plot
# source data from the function drawn from function documentation
# The goal in creating this function is to then create another function
#   that uses this to plot multiple models on the same interaction plot

interaction_plot_binary <- function(model, effect, moderator, interaction, varcov="default", conf=.95, title="Marginal effects plot", xlabel="Value of moderator", ylabel="Estimated marginal coefficient", factor_labels=c(0,1)){
  
  # Extract Variance Covariance matrix
  if (varcov == "default"){
    covMat = vcov(model)
  }else{
    covMat = varcov
  }
  
  # Extract the data frame of the model
  mod_frame = model.frame(model)
  
  # Get coefficients of variables
  beta_1 = model$coefficients[[effect]]
  beta_3 = model$coefficients[[interaction]]
  
  # Create list of moderator values at which marginal effect is evaluated
  x_2 <- c(0,1)
  
  # Compute marginal effects
  delta_1 = beta_1 + beta_3*x_2
  
  # Compute variances
  var_1 = covMat[effect,effect] + (x_2^2)*covMat[interaction, interaction] + 2*x_2*covMat[effect, interaction]
  
  # Standard errors
  se_1 = sqrt(var_1)
  
  ames_binary<-list(delta_1,se_1)
  
  # Upper and lower confidence bounds
  z_score = qnorm(1 - ((1 - conf)/2))
  upper_bound = delta_1 + z_score*se_1
  lower_bound = delta_1 - z_score*se_1
  
  # Determine the bounds of the graphing area
  max_y = max(upper_bound)
  min_y = min(lower_bound)
  
  myDataFrame <- data.frame(x_2, delta_1, upper_bound, lower_bound) 
  return(myDataFrame)
  
  # Initialize plotting window
  plot(x=c(), y=c(), ylim=c(min_y, max_y), xlim=c(-.5, 1.5), xlab=xlabel, ylab=ylabel, main=title, xaxt="n")
  
  
  # Plot points of estimated effects
  points(x=x_2, y=delta_1, pch=16)
  
  # Plot lines of confidence intervals
  lines(x=c(x_2[1], x_2[1]), y=c(upper_bound[1], lower_bound[1]), lty=1)
  points(x=c(x_2[1], x_2[1]), y=c(upper_bound[1], lower_bound[1]), pch=c(25,24), bg="black")
  lines(x=c(x_2[2], x_2[2]), y=c(upper_bound[2], lower_bound[2]), lty=1)
  points(x=c(x_2[2], x_2[2]), y=c(upper_bound[2], lower_bound[2]), pch=c(25,24), bg="black")
  
  
  # Label the axis
  axis(side=1, at=c(0,1), labels=factor_labels)
  
  # Add a dashed horizontal line for zero
  abline(h=0, lty=3)
  
}

```

```{r seanGraph, echo=FALSE}

##########################################
# Create Synthesized Plots from our models
##########################################

# sean_graph is a function that produces the bulk of the figures in the paper
# the general idea is that by inputting a list of models, it can plot their interaction
#   binary data on a graph side by side for easy comparison
# It uses a series of for loops such that unlimtied models can be added
# Also required for input is the labels, title, xlabel, and ylabel

sean_graph <- function(models, labels, effect, moderator, interaction, varcov="default", conf=.95, title="Marginal effects plot", xlabel="Value of moderator", ylabel="Estimated marginal coefficient", factor_labels=c(0,1)){

bar_size = .03
displace_size = .05

myData <- data.frame(x_2 = c(), delta_1 = c(), upper_bound = c(), lower_bound = c(), model = c()) 

for(i in 1:length(models)){
  
  temp_plot <- interaction_plot_binary(models[[i]], effect="women_composite", moderator="muslim.maj", interaction="women_composite:muslim.maj", factor_labels=c("Not Muslim Majority","Muslim Majority"), xlabel="", ylabel="Marginal Effect of Women's Rights on Coverage", title="")
  
  temp_plot_alt <- temp_plot %>% 
  mutate(model = labels[i]) %>% 
  mutate(offset = (i - 1)*displace_size)
  
  myData <- rbind(myData, temp_plot_alt)

}
 
# Calcluate where the breaks should go

spot1 <- displace_size/length(models)

# Plot all Data together

plot1 <- ggplot(myData) +
  
  # Add Points for Centers
  geom_point(aes(x = x_2 + offset, y = delta_1, color = model), size = 2) +
  
  geom_segment(aes(x = x_2 + offset, y = lower_bound, xend = x_2 + offset, yend = upper_bound, color = model)) + 
  
  geom_segment(aes(x = x_2 - bar_size + offset, y = lower_bound, xend = x_2 + bar_size + offset, yend = lower_bound, color = model)) + 
  
  geom_segment(aes(x = x_2 - bar_size + offset, y = upper_bound, xend = x_2 + bar_size + offset, yend = upper_bound, color = model)) +
  
  labs(y = ylabel, color="Data") + 
  
  scale_x_continuous(labels = c("Non-Muslim Country", "Muslim Country"), breaks=c(spot1, spot1 + 1)) +
  
  theme(axis.title.x=element_blank())

return(plot1)

}

```

```{r fig2m, echo = FALSE}

# Create figure 2 by plotting model nb1 with the sean_graph function

fig2m <- sean_graph(list(nb1), labels = c("All Data", "No Warzones"), title = "Marginal effects plot", xlabel = "Muslim Majority", ylabel = "Marginal Effect of Women's Rights on Coverage")

# Create figure 3 which compares nb1 and wnb1 by plotting them together with the seangraph
# function.

fig3m <- sean_graph(list(nb1, wnb1), labels = c("All Data", "No Warzones"), title = "Marginal effects plot", xlabel = "Muslim Majority", ylabel = "Marginal Effect of Women's Rights on Coverage")
```

```{r textData, echo = FALSE}

# This section focuses on creating the data for the Terrorism hypothesis section of the work

# Create a list of words to filter out

wordlist <- c("terroris", "bomb", "attack")

# get the correct article counts from the meta section

altered_text_data <- meta %>% 
  
  dplyr::select(COUNTRY_FINAL, SUBJECT, YEAR, TEXT) %>% 
  
  mutate(ccode = countrycode((COUNTRY_FINAL),  "country.name",  "cown")) %>% 
  
  # Filter out articles based on subject line
  
  mutate(subject = as.character(SUBJECT)) %>% 
  
  mutate(text = as.character(TEXT)) %>% 
  
  filter(!(grepl(paste(wordlist,collapse="|"), tolower(subject)))) %>% 
  
  # Count up the new amount of articles
  mutate(ccodeyear = paste0(ccode, YEAR)) %>% 
  
  dplyr::select(ccodeyear) %>% 
  
  group_by(ccodeyear) %>% 

  count() %>% 
  mutate(n.docs = freq) %>% 
  dplyr::select(n.docs, ccodeyear)

# Lag the freq by one year like they do in the main dataset
altered_text_data$n.docs <- lag(altered_text_data$n.docs, 1)

# Merge the columns together by ccode and year

merged_rt_data <- right_join(altered_text_data, rt_altered, by="ccodeyear") %>% 
  
  mutate(n.docs.final = case_when(
    is.na(n.docs.x) ~ 0,
    TRUE ~ as.numeric(n.docs.x)
  ))



```

```{r textData, echo = FALSE}

# Rerun the negative binomial model using muslim percentage with the new terrorism altered data

# MUSLIM MAJORITY

text_nb1 <- glm.nb(n.docs.final ~ count + women_composite*muslim.maj + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),data = merged_rt_data)
text_nb1.se <- coeftest(text_nb1, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# rerun models using the new terrorism altered data

fig4m <- sean_graph(list(nb1, wnb1, text_nb1), labels = c("All Data", "No Warzones", "No Terrorism"), title = "Marginal effects plot", xlabel = "Muslim Majority", ylabel = "Marginal Effect of Women's Rights on Coverage")

```

```{r bothData, echo=FALSE}

# Create one that removes warzones and text data

no_warzones_terrorism <- merged_rt_data %>% 
    
  filter(!(ccode %in% country_codes))

# Rerun the negative binomial model using muslim percentage with the new terrorism altered and war altered data

bothModels_nb1 <- glm.nb(n.docs.final ~ count + women_composite*muslim.maj + polity2 + domestic9 + log(pop.wdi) +log(gdp.pc.un),data = no_warzones_terrorism)
bothModels_nb1.se <- coeftest(text_nb1, vcov=function(x) vcovHC(x, cluster="group", type="HC1"))[,2]

# Use the sean_graph function to create a binary interaction plot with the new model data

fig5m <- sean_graph(list(nb1, wnb1, text_nb1, bothModels_nb1), labels = c("All Data", "No Warzones", "No Terrorism", "No war, No Terror"), title = "Marginal effects plot", xlabel = "Muslim Majority", ylabel = "Marginal Effect of Women's Rights on Coverage")


```


```{r whyTerrorism, echo=FASLE}

# Create a new plot that demonstrates why the hypothesis are worth pursuing
# This plot is intended to better visualize the data
# 

whyTerrorism <- rt_altered %>% 
  
  # create a new variable that checks whether or not a country is at war
  
  mutate(countryType = case_when(
    (ccode %in% country_codes) ~ "At War",
    TRUE ~ "Not at War"
         )) %>%
  
  # filter for rows that have a women's rights composite score
  
  filter(!is.na(women_composite)) %>% 
  
  # filter for only muslim countries (>%50 muslim)
  
  filter(muslim > .5) %>% 
  
  # summarize the mean women's rights score by year and country type
  
  group_by(year, countryType) %>% 
  dplyr::summarize(meanWomen = mean(women_composite)) %>% 
  
  # ggplot the data. put year on the x axis and women's rights score on the y
  
  ggplot(aes(x = year, y = meanWomen)) +
  
  # Put down point at each location, and a line connecting the points
  
  geom_point(aes(color = countryType), size = 3, alpha = .3) + 
  geom_point(aes(color = countryType), size = 1, alpha = 1) + 
  geom_line(aes(color = countryType), alpha=.3) +
  
  # Use geom smooth to add trendlines
  
  geom_smooth(aes(color = countryType), alpha = .15, method ='loess', formula="y ~ x") +
  
  # Add labels and remove gridlines
  
  labs(title = "Mean Womens' Rights Composite Score in Muslim Countries (NAW vs AW)",
       x = "Year", color = "Country Status",
       y = "Mean Womens' Rights Composite Score") +
  theme_bw()

```

```{r whyTerrorism2, echo=FASLE}

# This section of code follows the same pattern as the last section, except for key
#   differences which are commented

whyTerrorism2 <- rt_altered %>% 
  mutate(countryType = case_when(
    (ccode %in% country_codes) ~ "At War",
    TRUE ~ "Not at War"
         )) %>% 
  filter(!is.na(women_composite)) %>% 
  filter(muslim > .5) %>% 
  
  # calculate the mean number of documents published for each year and country type
  
  group_by(year, countryType) %>% 
  dplyr::summarize(ncountmean = mean(n.docs)) %>% 
  ggplot(aes(x = year, y = ncountmean)) +
  geom_point(aes(color = countryType), size = 3, alpha = .3) + 
  geom_point(aes(color = countryType), size = 1, alpha = 1) + 
  geom_line(aes(color = countryType), alpha=.3) +
  geom_smooth(aes(color = countryType), alpha = .15, method ='loess', formula="y ~ x") +
  labs(title = "Mean Coverage in Muslim Countries (NAW vs AW)",
       x = "Year", color = "Country Status",
       y = "Mean number of articles") +
  theme_bw()

```

```{r whyTerrorism3, echo=FASLE}

# This section of code examines the number of articles published by country type and year
#   however it adjusts for the total number of articles published in those areas. (count vs n.count)

rt_altered %>% 
  mutate(countryType = case_when(
    (ccode %in% country_codes) ~ "At War",
    TRUE ~ "Not at War"
         )) %>% 
  filter(muslim > .5) %>% 
  group_by(year, countryType) %>% 
  dplyr::summarize(ncountmean = sum(n.docs)/sum(count)) %>% 
  ggplot(aes(x = year, y = ncountmean)) +
  geom_point(aes(color = countryType), size = 3, alpha = .3) + 
  geom_point(aes(color = countryType), size = 1, alpha = 1) + 
  geom_line(aes(color = countryType), alpha=.3) +
  geom_smooth(aes(color = countryType), alpha = .15, method ='loess', formula="y ~ x") +
  labs(title = "Mean Coverage in Muslim Countries (NAW vs AW)",
       x = "Year", color = "Country Status",
       y = "Mean number of articles") +
  theme_bw()



```

```{r saveApen, include=FALSE}

# This section of code is used to save all data files for the main writeup
# While it is difficult to work with, this was the best solution I could
#   find for avoiding putting all of the code in the paper

# Appendix Files
saveRDS(apent11, './writeup_files/apent11.RDS')
saveRDS(apent12, './writeup_files/apent12.RDS')
saveRDS(apent13, './writeup_files/apent13.RDS')
saveRDS(apent14, './writeup_files/apent14.RDS')
saveRDS(apent15, './writeup_files/apent15.RDS')
saveRDS(apent16, './writeup_files/apent16.RDS')
saveRDS(apent21, './writeup_files/apent21.RDS')
saveRDS(apent22, './writeup_files/apent22.RDS')
saveRDS(apent23, './writeup_files/apent23.RDS')
saveRDS(apent24, './writeup_files/apent24.RDS')
saveRDS(apent25, './writeup_files/apent25.RDS')
saveRDS(apent26, './writeup_files/apent26.RDS')
saveRDS(apent3, './writeup_files/apent3.RDS')
saveRDS(apent41, './writeup_files/apent41.RDS')
saveRDS(apent42, './writeup_files/apent42.RDS')
saveRDS(apent43, './writeup_files/apent43.RDS')
saveRDS(apent44, './writeup_files/apent44.RDS')
saveRDS(apent45, './writeup_files/apent45.RDS')
saveRDS(apent46, './writeup_files/apent46.RDS')
saveRDS(apen2, './writeup_files/apen2.RDS')
saveRDS(apen3, './writeup_files/apen3.RDS')
saveRDS(apen41, './writeup_files/apen41.RDS')
saveRDS(apen42, './writeup_files/apen42.RDS')

# Main Paper File

# Table 1: Probit Analysis
saveRDS(wlogit1, './writeup_files/wlogit11.RDS')
saveRDS(wlogit2, './writeup_files/wlogit12.RDS')
saveRDS(wlogit3, './writeup_files/wlogit13.RDS')
saveRDS(wlogit1.se, './writeup_files/wlogit14.RDS')
saveRDS(wlogit2.se, './writeup_files/wlogit15.RDS')
saveRDS(wlogit3.se, './writeup_files/wlogit16.RDS')

# Table 2: Negative Binomial Analysis
saveRDS(wnb1, './writeup_files/wnb11.RDS')
saveRDS(wnb2, './writeup_files/wnb12.RDS')
saveRDS(wnb3, './writeup_files/wnb13.RDS')
saveRDS(wnb1.se, './writeup_files/wnb14.RDS')
saveRDS(wnb2.se, './writeup_files/wnb15.RDS')
saveRDS(wnb3.se, './writeup_files/wnb16.RDS')

# Figure 2: Marginal Effects Plot

saveRDS(fig2m, './writeup_files/fig2m.RDS')

# Figure 3: No War Marginal Effects Plot

saveRDS(fig3m, './writeup_files/fig3m.RDS')

# Figure 4: No Terms Marginal Effects Plot

saveRDS(fig4m, './writeup_files/fig4m.RDS')

# Figure 5: Combined Marginal Effects Plot

saveRDS(fig5m, './writeup_files/fig5m.RDS')

# Why Removing Terrorism Plot

saveRDS(whyTerrorism, './writeup_files/whyTerrorism.RDS')
saveRDS(whyTerrorism2, './writeup_files/whyTerrorism2.RDS')

```
